# ReportFlow - Reporting Platform Documentation

## Overview:

ReportFlow is a serverless reporting platform built on AWS that extracts data from Amazon Redshift, processes it, and stores the results in a CSV file in an S3 bucket. The platform includes two main AWS Lambda functions and interacts with AWS Redshift, Secrets Manager, and S3 for data handling.

## Components:

### 1. AWS Lambda Functions

#### 1.1. reportflow_report_prep
This Lambda function is responsible for querying data from the Redshift database, processing it, and storing the output into a Redshift table (report_output).

- **Purpose**: Prepares the report data by querying two source tables from Redshift, performing necessary transformations, and storing the results in the report_output table.
- **Triggers**: Invoked manually or by an event (could be scheduled via Amazon CloudWatch Events).
- **Environment Variables**:
  - `REDSHIFT_CLUSTER_ID`: The Redshift Serverless cluster ID.
  - `REDSHIFT_DB`: The name of the Redshift database.
  - `REDSHIFT_USER`: The Redshift username to connect with.
  - `REDSHIFT_SECRET_ARN`: The ARN of the Redshift credentials stored in AWS Secrets Manager.
  - `REDSHIFT_WORKGROUP_ID`: The Workgroup ID of the Redshift Serverless instance.

- **IAM Role**: Has permissions for:
  - Redshift Data API (`redshift-data:ExecuteStatement`, `redshift-data:GetStatementResult`).
  - Secrets Manager (`secretsmanager:GetSecretValue`).

- **Process**:
  1. Connects to Redshift using the Data API and credentials stored in Secrets Manager.
  2. Executes the necessary SQL queries to fetch data from source tables (e.g., transactions and clients).
  3. Processes the data and inserts it into the report_output table in Redshift.

#### 1.2. reportflow_report_file
This Lambda function reads the data stored in the report_output table, formats it into a CSV file, and uploads the file to an S3 bucket.

- **Purpose**: Retrieves the results from report_output and generates a CSV file for storage in the S3 bucket.
- **Triggers**: Invoked manually or after the completion of `reportflow_report_prep`.
- **Environment Variables**:
  - `REDSHIFT_WORKGROUP_ID`: The Workgroup ID of the Redshift Serverless instance.
  - `REDSHIFT_DB`: The name of the Redshift database.
  - `REDSHIFT_SECRET_ARN`: The ARN of the Redshift credentials stored in AWS Secrets Manager.
  - `S3_BUCKET_NAME`: The name of the S3 bucket to store the generated CSV file.

- **IAM Role**: Has permissions for:
  - Redshift Data API (`redshift-data:ExecuteStatement`, `redshift-data:GetStatementResult`).
  - S3 (`s3:PutObject`).
  - Secrets Manager (`secretsmanager:GetSecretValue`).

- **Process**:
  1. Executes a query (SELECT * FROM `report_output`) to fetch the prepared report data.
  2. Formats the query results into CSV.
  3. Uploads the CSV file to the designated S3 bucket using the `put_object` API call.

### 2. AWS Services

#### 2.1. Amazon Redshift Serverless
- **Purpose**: Redshift Serverless is used to store and process large datasets. The data preparation and querying steps are performed on Redshift, and the results are stored in the report_output table.
- **Components**:
  - Workgroup: The serverless cluster is organized into a workgroup, which is referenced by the Lambda functions for querying data.

#### 2.2. AWS Secrets Manager
- **Purpose**: Secrets Manager stores the Redshift credentials (username and password) securely and allows Lambda functions to retrieve them without hardcoding sensitive information.
- **Components**:
  - Secret: Stores the Redshift credentials (username and password) for accessing the database.

#### 2.3. Amazon S3
- **Purpose**: S3 is used to store the final output CSV file generated by the `reportflow_report_file` Lambda function.
- **Bucket**: The CSV file is saved in an S3 bucket (e.g., reportflow) with a unique file name based on a timestamp.

### Process Flow:
1. **Data Preparation**:
   - The `reportflow_report_prep` Lambda function queries source tables in Amazon Redshift (e.g., transactions and clients), processes the data, and inserts it into the `report_output` table.

2. **Report Generation**:
   - The `reportflow_report_file` Lambda function retrieves the prepared data from the `report_output` table, formats it as a CSV file, and uploads it to an S3 bucket for storage.

3. **CSV File**:
   - The generated CSV file is named using a timestamp to ensure uniqueness (e.g., `report_output_<timestamp>.csv`) and is stored in the designated S3 bucket.

### IAM Roles & Permissions:
- **Roles & Policies**: Both Lambda functions share the same IAM role (`reportflow_report_prep-role`), which must have the following policies attached:
  - Redshift Data API: `redshift-data:ExecuteStatement`, `redshift-data:GetStatementResult`.
  - S3: `s3:PutObject`.
  - Secrets Manager: `secretsmanager:GetSecretValue`.

### Conclusion:
ReportFlow is a powerful and scalable reporting solution that automates the process of querying, processing, and exporting data from Redshift to S3. By leveraging AWS Lambda, Redshift Serverless, and other AWS services like Secrets Manager and S3, it provides an easy-to-use and serverless approach to data reporting.
